# 电梯监控系统部署说明文档

本文档提供电梯监控系统的完整部署流程，包括环境配置、安装步骤、配置选项和常见问题解决方案。

## 目录
- [系统要求](#系统要求)
- [环境准备](#环境准备)
- [前端部署](#前端部署)
- [后端部署](#后端部署)
- [数据库配置](#数据库配置)
- [系统配置](#系统配置)
- [启动服务](#启动服务)
- [验证部署](#验证部署)
- [常见问题](#常见问题)

## 系统要求

### 硬件要求
- **服务器**：
  - CPU: 4核心以上
  - 内存: 8GB以上
  - 存储: 100GB以上
  - 网络: 100Mbps以上带宽

### 软件要求
- **操作系统**：
  - Linux (推荐 Ubuntu 20.04 LTS 或 CentOS 8)
  - Windows Server 2019 (可选)
- **运行环境**：
  - Node.js 16.x 或更高版本
  - npm 8.x 或更高版本
  - MongoDB 5.0 或更高版本
  - Redis 6.x 或更高版本
- **Web服务器**：
  - Nginx 1.20 或更高版本
  - Apache 2.4 (可选)

## 环境准备

### 安装Node.js和npm

在Ubuntu系统上:

```bash
# 添加Node.js源
curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash -

# 安装Node.js和npm
sudo apt-get install -y nodejs

# 验证安装
node -v
npm -v
```

在CentOS系统上:

```bash
# 添加Node.js源
curl -fsSL https://rpm.nodesource.com/setup_16.x | sudo bash -

# 安装Node.js和npm
sudo yum install -y nodejs

# 验证安装
node -v
npm -v
```

### 安装MongoDB

在Ubuntu系统上:

```bash
# 导入公钥
wget -qO - https://www.mongodb.org/static/pgp/server-5.0.asc | sudo apt-key add -

# 添加MongoDB源
echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/5.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-5.0.list

# 更新包索引
sudo apt-get update

# 安装MongoDB
sudo apt-get install -y mongodb-org

# 启动MongoDB服务
sudo systemctl start mongod

# 设置开机自启
sudo systemctl enable mongod
```

在CentOS系统上:

```bash
# 创建MongoDB源文件
cat <<EOF | sudo tee /etc/yum.repos.d/mongodb-org-5.0.repo
[mongodb-org-5.0]
name=MongoDB Repository
baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/5.0/x86_64/
gpgcheck=1
enabled=1
gpgkey=https://www.mongodb.org/static/pgp/server-5.0.asc
EOF

# 安装MongoDB
sudo yum install -y mongodb-org

# 启动MongoDB服务
sudo systemctl start mongod

# 设置开机自启
sudo systemctl enable mongod
```

### 安装Redis

在Ubuntu系统上:

```bash
# 安装Redis
sudo apt-get install redis-server

# 启动Redis服务
sudo systemctl start redis-server

# 设置开机自启
sudo systemctl enable redis-server
```

在CentOS系统上:

```bash
# 安装EPEL仓库
sudo yum install epel-release

# 安装Redis
sudo yum install redis

# 启动Redis服务
sudo systemctl start redis

# 设置开机自启
sudo systemctl enable redis
```

### 安装Nginx

在Ubuntu系统上:

```bash
# 安装Nginx
sudo apt-get install nginx

# 启动Nginx服务
sudo systemctl start nginx

# 设置开机自启
sudo systemctl enable nginx
```

在CentOS系统上:

```bash
# 安装Nginx
sudo yum install nginx

# 启动Nginx服务
sudo systemctl start nginx

# 设置开机自启
sudo systemctl enable nginx
```

## 前端部署

### 克隆项目

```bash
# 克隆前端项目仓库
git clone https://github.com/your-organization/elevator-monitoring-frontend.git

# 进入项目目录
cd elevator-monitoring-frontend
```

### 安装依赖

```bash
# 安装项目依赖
npm install
```

### 配置环境变量

创建或编辑`.env.production`文件:

```
VUE_APP_API_URL=https://api.your-domain.com
VUE_APP_SOCKET_URL=wss://api.your-domain.com/ws
VUE_APP_VERSION=1.0.0
```

### 构建生产版本

```bash
# 构建生产版本
npm run build
```

### 部署到Nginx

配置Nginx服务器:

```bash
# 创建Nginx配置文件
sudo nano /etc/nginx/sites-available/elevator-frontend
```

添加以下配置:

```nginx
server {
    listen 80;
    server_name monitoring.your-domain.com;
    
    root /var/www/elevator-monitoring-frontend/dist;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # 缓存静态资源
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 30d;
        add_header Cache-Control "public, no-transform";
    }
    
    # 禁止访问敏感文件
    location ~ /\.(?!well-known) {
        deny all;
    }
}
```

启用站点配置:

```bash
# 创建符号链接
sudo ln -s /etc/nginx/sites-available/elevator-frontend /etc/nginx/sites-enabled/

# 复制构建文件到服务器目录
sudo mkdir -p /var/www/elevator-monitoring-frontend
sudo cp -r dist/* /var/www/elevator-monitoring-frontend/dist/

# 验证Nginx配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
```

## 后端部署

### 克隆项目

```bash
# 克隆后端项目仓库
git clone https://github.com/your-organization/elevator-monitoring-backend.git

# 进入项目目录
cd elevator-monitoring-backend
```

### 安装依赖

```bash
# 安装项目依赖
npm install
```

### 配置环境变量

创建`.env`文件:

```
# 服务器配置
PORT=3000
NODE_ENV=production

# 数据库配置
MONGODB_URI=mongodb://localhost:27017/elevator_monitoring
REDIS_URI=redis://localhost:6379

# JWT配置
JWT_SECRET=your_jwt_secret_key
JWT_EXPIRATION=86400

# 其他配置
LOG_LEVEL=info
CORS_ORIGIN=https://monitoring.your-domain.com
```

### 配置PM2进程管理

安装PM2:

```bash
# 全局安装PM2
sudo npm install -g pm2
```

创建PM2配置文件`ecosystem.config.js`:

```javascript
module.exports = {
  apps: [{
    name: 'elevator-monitoring-api',
    script: 'src/server.js',
    instances: 'max',
    exec_mode: 'cluster',
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production'
    }
  }]
};
```

### 启动应用

```bash
# 使用PM2启动应用
pm2 start ecosystem.config.js

# 保存PM2配置
pm2 save

# 设置PM2开机自启
pm2 startup
```

### 配置Nginx反向代理

创建或编辑Nginx配置文件:

```bash
sudo nano /etc/nginx/sites-available/elevator-backend
```

添加以下配置:

```nginx
server {
    listen 80;
    server_name api.your-domain.com;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
    
    # WebSocket支持
    location /ws {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
    }
}
```

启用站点配置:

```bash
# 创建符号链接
sudo ln -s /etc/nginx/sites-available/elevator-backend /etc/nginx/sites-enabled/

# 验证Nginx配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
```

## 数据库配置

### MongoDB初始化

创建数据库用户:

```bash
# 连接MongoDB
mongo

# 切换到admin数据库
use admin

# 创建管理员用户
db.createUser({
  user: "admin",
  pwd: "secure_password",
  roles: [ { role: "userAdminAnyDatabase", db: "admin" } ]
})

# 切换到应用数据库
use elevator_monitoring

# 创建应用用户
db.createUser({
  user: "elevator_app",
  pwd: "app_secure_password",
  roles: [ { role: "readWrite", db: "elevator_monitoring" } ]
})

# 退出
exit
```

### 启用MongoDB认证

编辑MongoDB配置文件:

```bash
sudo nano /etc/mongod.conf
```

添加或修改安全配置:

```yaml
security:
  authorization: enabled
```

重启MongoDB:

```bash
sudo systemctl restart mongod
```

### 数据备份配置

创建备份脚本`backup_mongodb.sh`:

```bash
#!/bin/bash
TIMESTAMP=$(date +"%Y%m%d%H%M%S")
BACKUP_DIR="/var/backups/mongodb"
mkdir -p $BACKUP_DIR
mongodump --host localhost --port 27017 --username elevator_app --password app_secure_password --db elevator_monitoring --out $BACKUP_DIR/$TIMESTAMP
find $BACKUP_DIR -type d -mtime +7 -exec rm -rf {} \;
```

添加执行权限:

```bash
chmod +x backup_mongodb.sh
```

配置定时任务:

```bash
crontab -e
```

添加每日备份任务:

```
0 2 * * * /path/to/backup_mongodb.sh
```

## 系统配置

### 防火墙配置

在Ubuntu系统上:

```bash
# 允许SSH连接
sudo ufw allow ssh

# 允许HTTP和HTTPS连接
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 启用防火墙
sudo ufw enable
```

在CentOS系统上:

```bash
# 允许SSH连接
sudo firewall-cmd --permanent --add-service=ssh

# 允许HTTP和HTTPS连接
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https

# 重新加载防火墙规则
sudo firewall-cmd --reload
```

### SSL配置

使用Let's Encrypt安装SSL证书:

在Ubuntu系统上:

```bash
# 安装certbot
sudo apt-get install certbot python3-certbot-nginx

# 获取并安装证书
sudo certbot --nginx -d monitoring.your-domain.com -d api.your-domain.com
```

在CentOS系统上:

```bash
# 安装EPEL仓库
sudo yum install epel-release

# 安装certbot
sudo yum install certbot python3-certbot-nginx

# 获取并安装证书
sudo certbot --nginx -d monitoring.your-domain.com -d api.your-domain.com
```

### 系统优化

编辑系统限制配置:

```bash
sudo nano /etc/security/limits.conf
```

添加以下配置:

```
# 增加文件描述符限制
*         soft    nofile      65535
*         hard    nofile      65535
```

编辑sysctl配置:

```bash
sudo nano /etc/sysctl.conf
```

添加以下配置:

```
# 网络优化
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_keepalive_time = 1200
net.ipv4.tcp_max_syn_backlog = 8192
net.ipv4.tcp_tw_reuse = 1
```

应用更改:

```bash
sudo sysctl -p
```

## 启动服务

### 服务启动顺序

1. 启动MongoDB:
```bash
sudo systemctl start mongod
```

2. 启动Redis:
```bash
sudo systemctl start redis
```

3. 启动后端服务:
```bash
cd /path/to/elevator-monitoring-backend
pm2 start ecosystem.config.js
```

4. 启动Nginx:
```bash
sudo systemctl start nginx
```

### 验证服务状态

```bash
# 检查MongoDB状态
sudo systemctl status mongod

# 检查Redis状态
sudo systemctl status redis

# 检查PM2进程
pm2 status

# 检查Nginx状态
sudo systemctl status nginx
```

## 验证部署

### API测试

```bash
# 测试API健康检查端点
curl https://api.your-domain.com/health

# 测试API版本端点
curl https://api.your-domain.com/version
```

### 前端访问

在浏览器中访问 `https://monitoring.your-domain.com` 验证前端应用是否正常运行。

### 日志检查

```bash
# 检查Nginx错误日志
sudo tail -f /var/log/nginx/error.log

# 检查PM2日志
pm2 logs

# 检查MongoDB日志
sudo tail -f /var/log/mongodb/mongod.log
```

## 常见问题

### 1. 无法连接到MongoDB

**问题**: 应用无法连接到MongoDB数据库。

**解决方案**:
- 检查MongoDB服务是否运行: `sudo systemctl status mongod`
- 检查MongoDB连接字符串是否正确
- 确认防火墙没有阻止MongoDB端口(27017)
- 验证MongoDB用户凭据是否正确

### 2. 前端显示空白页面

**问题**: 访问前端页面时显示空白。

**解决方案**:
- 检查浏览器控制台错误
- 确认Nginx配置中的root路径是否正确
- 验证前端构建是否成功
- 检查API URL配置是否正确

### 3. WebSocket连接失败

**问题**: 实时数据无法通过WebSocket接收。

**解决方案**:
- 确认Nginx WebSocket配置是否正确
- 检查防火墙是否允许WebSocket连接
- 验证后端WebSocket服务是否正常运行
- 检查浏览器控制台中的WebSocket错误

### 4. 系统负载过高

**问题**: 服务器CPU或内存使用率过高。

**解决方案**:
- 检查MongoDB查询性能
- 调整PM2实例数量
- 增加服务器资源
- 优化数据库索引
- 实施缓存策略

### 5. 证书过期

**问题**: SSL证书过期导致安全警告。

**解决方案**:
- 更新Let's Encrypt证书: `sudo certbot renew`
- 配置自动更新: `sudo systemctl enable certbot.timer`
- 验证证书状态: `sudo certbot certificates`

## 维护计划

### 日常维护

- 每日检查系统日志
- 监控系统资源使用情况
- 验证数据库备份是否成功

### 定期维护

- 每周更新系统软件包
- 每月更新Node.js依赖
- 每季度审查系统安全性
- 每半年进行性能评估和优化

### 升级计划

系统升级步骤:

1. 备份所有数据
2. 更新后端代码
3. 更新前端代码
4. 测试新版本
5. 如有问题，回滚到上一版本

## 联系支持

如遇到无法解决的问题，请联系系统维护团队:

- 电子邮件: support@your-organization.com
- 技术支持热线: +86-10-12345678
- 工作时间: 周一至周五 9:00-18:00 